<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:sftp="http://www.mulesoft.org/schema/mule/sftp" xmlns:file="http://www.mulesoft.org/schema/mule/file"
	xmlns:os="http://www.mulesoft.org/schema/mule/os"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/os http://www.mulesoft.org/schema/mule/os/current/mule-os.xsd
http://www.mulesoft.org/schema/mule/file http://www.mulesoft.org/schema/mule/file/current/mule-file.xsd
http://www.mulesoft.org/schema/mule/sftp http://www.mulesoft.org/schema/mule/sftp/current/mule-sftp.xsd">
	<sub-flow name="delivery-order-to-cwm-sapi" doc:id="ca671ed8-eea9-4c8c-b578-c9316e4ffebc" >
		<parallel-foreach doc:name="Parallel For Each" doc:id="1ed92d6e-8791-4732-ae2d-e148e537fcd4">
					<try doc:name="Try" doc:id="6e765e19-fcb5-4ad6-8e83-c245946ffb39">
					<ee:transform doc:name="Checking Required Parameters" doc:id="dbb6863a-1341-46ab-933a-2de18ebb6526">
			<ee:message>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="requiredParameters"><![CDATA[%dw 2.0
output application/json
import * from dw::Runtime
var orderType = payload.deliveryOrderType
---
{
	"shippingNumber": payload.deliveryOrderNumber default "NoShippingNumber",
	"missing": orderType match{
		case "EXPORT" -> if(payload.bookingNumber==null or payload.documentationCutOffDate==null or payload.cutOffDate==null) "Y" else "N"
		case "IMPORT" -> if(payload.billOfLading==null) "Y" else "N"
		case "DOMESTIC" -> if(payload.billOfLading==null) "Y" else "N"
		
}}]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
				<choice doc:name="Is Required Parameters Missing?" doc:id="344129ad-dd5e-42c8-a75e-dc492ca0dbfb">
			<when expression='vars.requiredParameters.missing =="Y"'>
				<flow-ref doc:name="required-parameters-missing" doc:id="98198c69-8e62-4477-a3c9-a3c28637c901" name="required-parameters-missing" />
			</when>
			<otherwise>
				<flow-ref doc:name="mile-log:payload-logger" doc:id="4781c5e3-93d8-4580-ba6b-e7f025df767c" name="mile-log:payload-logger"/>
						<http:request method="POST" doc:name="cwm-sapi" doc:id="2c2265d1-5687-4b9a-b171-e04ca0c25c4f" config-ref="cwm-sapi" path="/{httpRequestcwm.path}" responseTimeout="${httpRequestcwm.responseTimeout}">
				<reconnect frequency="${httpRequestcwm.frequency}" count="${httpRequestcwm.retryCount}" />
							<http:headers><![CDATA[#[output application/json
---
{
	correlationId : vars.correlationId
}]]]></http:headers>
			</http:request>
						<flow-ref doc:name="mile-log:payload-logger" doc:id="77164fad-ffe6-45c3-8298-2719233aa338" name="mile-log:payload-logger"/>
						<flow-ref doc:name="mile-log:success-response-received" doc:id="1f90d5ca-b742-44a3-bf2f-6fa827c5c00f" name="mile-log:success-response-received"/>
			</otherwise>
		</choice>
				<error-handler>
						<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="26147dc7-57c0-408d-bdbf-1e77444cf012" type="HTTP:BAD_REQUEST">
							<flow-ref doc:name="required-parameters-missing" doc:id="608a36cf-e3a6-417f-9bca-5818de6898f7" name="required-parameters-missing" />
						</on-error-continue>
					<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="baffe5ed-c0d4-4a79-9ffe-471a42fadf57" >
						<flow-ref doc:name="mile-log:failure-response-received" doc:id="761fba4e-8a6a-4d51-a12c-900321968b71" name="mile-log:failure-response-received"/>
						<ee:transform doc:name="error-message" doc:id="c3cffeee-2f9e-4e1e-968c-afd0c6d640cf" >
							<ee:message >
								<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  error: error.description
}]]></ee:set-payload>
							</ee:message>
						</ee:transform>
						<flow-ref doc:name="mile-log:failure-response-sent" doc:id="e9da33e2-0f58-4cce-b4d3-55e56e2de8e3" name="mile-log:failure-response-sent"/>
					</on-error-continue>
					</error-handler>
				</try>
				</parallel-foreach>
	</sub-flow>
	<sub-flow name="required-parameters-missing" doc:id="2278294a-806d-4995-a8a4-27ec3f982aa8" >
		<flow-ref doc:name="mile-log:failure-response-received" doc:id="c2ddd5e7-de8d-4490-87a6-a5fcf7e88c78" name="mile-log:failure-response-received"/>
		<ee:transform doc:name="Set Json To CSV" doc:id="10235869-d35c-44e9-b668-0712a587e638" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/csv
---
{
	"shipmentNumber": payload.deliveryOrderNumber default "",
	"Origin Port (UNLOCODE)": payload.originUnlocode default "",
	"Destination Port (UNLOCODE)": payload.destinationUnlocode default "",
	"Customer": payload.customerName default "",
	scheduledPickupDate: payload.deliverySchedule."plannedPickup" default "",
	scheduledDeliveryDate:payload.deliverySchedule."scheduledDeliveryDate" default "",
	"Ocean Carrier": payload.oceanCarrier default "",
	"VesselName": payload.vesselName default "",
	"Origin Name/Terminal": payload.stops.locationName[0] default "",
	"Origin Address": payload.stops.locationAddress1[0] default "",
	"Origin City": payload.stops.city[0] default "",
	"Origin State": payload.stops.state[0] default "",
	"Origin Postal Code":payload.stops.postalCode[0] default "",
	"Origin Country":payload.stops.country[0] default "",
	"Final Destination Name":payload.stops.locationName[1] default "",
	"Final Destination Address":payload.stops.locationAddress1[1] default "",
	"Final Destination City":payload.stops.city[1] default "",
	"Final Destination State": payload.stops.state[1] default "",
	"Final Destination Postal Code":payload.stops.postalCode[1] default "",
	"Final Destination Country":payload.stops.country[1] default "",
	"commodityClass": payload."cargo"."commodityClass" default "",
	"commodityGoodsNo": payload."cargo"."commodityGoodsNumber" default "",
	"equipmentType": payload."container"."equipmentSizeType" default "",
	"containerId": payload."container"."number" default "",
	"grossWeight": payload."cargo"."grossWeight" default "",
	"netWeight": payload."cargo"."netWeight" default "",
	"weightUOM": payload."cargo"."grossWeightUOM" default "",
	"pieces": payload."cargo"."quantity" default "",
	"sealNo": payload."container"."seal" default "",
	"Bill of Lading": payload."billOfLading" default "",
	"Booking Number":payload."bookingNo" default "",
	"VV_Invoice_No__Import":payload."invoiceReferenceNumber" default "",
	"PackageType":payload."cargo"."packageType" default "",
	"FreightDescription":payload."cargo"."freightDescription" default "",
	"Volume":payload."cargo"."grossVolume" default "",
	"VolumeUOM":payload."cargo"."grossVolumeUOM" default "",
	"Voyage Number":payload.voyageNumber default "",
	"Planned Vessel Departure":payload."deliverySchedule"."plannedVesselDeparture" default "",
	"Shipment Type":payload."deliveryOrderType" default "",
	"BCO Name":payload.bcoName default "",
	"Ocean Carrier SCAC":payload."standardCarrierAlphaCode" default "",
	"Cut-off Date":payload."deliverySchedule"."cutOffDate" default "",
	"Documentation Cut-off Date":payload."deliverySchedule"."documentationCutOffDate" default ""
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<sftp:write doc:name="Write" doc:id="25e9f971-b5b4-4002-a9a9-5176572cd61f" config-ref="SFTP_VV_Config" path="#[Mule::p('sftpvv.filePathFailed') as String ++ now() as String {format:&quot;yyyyMMddHHmmSSss&quot;} ++ &quot;.csv&quot;]" mode="APPEND" />
		<ee:transform doc:name="Set Error Response" doc:id="0df7456c-0f6e-4897-8118-5ffa469a346e" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	"shipmentNumber":vars.requiredParameters.shippingNumber,
	"message": "Required parameters are missing; data has been converted to CSV format and written to the failure folder."
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<flow-ref doc:name="mile-log:failure-response-sent" doc:id="e26172fa-9f0e-4aec-9617-f0e85e8b3845" name="mile-log:failure-response-sent"/>
	</sub-flow>
	</mule>
